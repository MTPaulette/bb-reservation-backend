// app/Providers/MailConfigServiceProvider.php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\Mail;
use App\Models\Option;

class MailConfigServiceProvider extends ServiceProvider
{
    public function boot()
    {
        $this->configureMail();
        $this->listenForOptionChanges();
    }

    protected function configureMail()
    {
        $options = Option::where('key', 'mail_config')->first();

        if ($options) {
            $mailConfig = json_decode($options->value, true);

            config([
                'mail.mailers.smtp.host' => $mailConfig['host'],
                'mail.mailers.smtp.port' => $mailConfig['port'],
                'mail.mailers.smtp.username' => $mailConfig['username'],
                'mail.mailers.smtp.password' => $mailConfig['password'],
                'mail.from.address' => $mailConfig['from_address'],
                'mail.from.name' => $mailConfig['from_name'],
            ]);

            Mail::reconnect();
        }
    }

    protected function listenForOptionChanges()
    {
        Option::updated(function ($option) {
            if ($option->key === 'mail_config') {
                $this->configureMail();
            }
        });
    }
}
=====================================================


Voici les étapes à suivre :

1. Créez un nouveau fichier de vue dans le répertoire resources/views/email/passwords (par exemple, reset.blade.php).
2. Dans ce fichier, vous pouvez personnaliser le design du mail en utilisant les variables suivantes :
    - $token : le token de réinitialisation de mot de passe.
    - $user : l'utilisateur qui a demandé la réinitialisation de mot de passe.
3. Utilisez les balises Blade pour afficher les variables et créer le design du mail.
4. Enregistrez le fichier de vue.

Exemple de code pour le fichier reset.blade.php :

<!DOCTYPE html>
<html>
<head>
    <title>Réinitialisation de mot de passe</title>
</head>
<body>
    <h1>Réinitialisation de mot de passe</h1>
    <p>Bonjour {{ $user->name }},</p>
    <p>Vous avez demandé la réinitialisation de votre mot de passe. Pour réinitialiser votre mot de passe, cliquez sur le lien suivant :</p>
    <p><a href="{{ url('password/reset', $token) }}">Réinitialiser mon mot de passe</a></p>
    <p>Cordialement,</p>
    <p>[Votre nom]</p>
</body>
</html>

1. Pour utiliser ce nouveau fichier de vue, vous devez configurer Laravel pour utiliser ce fichier de vue pour les emails de réinitialisation de mot de passe. Vous pouvez le faire en ajoutant la ligne suivante dans le fichier config/mail.php :

'passwords' => [
    'reset' => 'email.passwords.reset',
],

1. Enfin, vous devez mettre à jour le fichier app/Http/Controllers/Auth/ResetPasswordController.php pour utiliser le nouveau fichier de vue. Vous pouvez le faire en ajoutant la ligne suivante dans la méthode sendResetLinkEmail :

return view('email.passwords.reset', ['token' => $token, 'user' => $user]);



==========================


Pour modifier le design du mail envoyé lors de la réinitialisation du mot de passe dans Laravel 9, vous devez créer des vues pour les emails de réinitialisation de mot de passe en français et en anglais.

Voici les étapes à suivre :

1. Créez des répertoires pour les vues des emails de réinitialisation de mot de passe en français et en anglais dans le répertoire resources/views/auth/emails/password :
    - reset-fr.blade.php pour la vue en français
    - reset-en.blade.php pour la vue en anglais
2. Dans ces vues, vous pouvez personnaliser le design du mail en utilisant les variables suivantes :
    - $token : le token de réinitialisation de mot de passe
    - $user : l'utilisateur qui a demandé la réinitialisation de mot de passe
3. Utilisez les balises Blade pour afficher les variables et créer le design du mail.

Exemple de code pour la vue en français (reset-fr.blade.php) :

<!DOCTYPE html>
<html>
<head>
    <title>Réinitialisation de mot de passe</title>
</head>
<body>
    <h1>Réinitialisation de mot de passe</h1>
    <p>Bonjour {{ $user->name }},</p>
    <p>Vous avez demandé la réinitialisation de votre mot de passe. Pour réinitialiser votre mot de passe, cliquez sur le lien suivant :</p>
    <p><a href="{{ url('password/reset', $token) }}">Réinitialiser mon mot de passe</a></p>
    <p>Cordialement,</p>
    <p>[Votre nom]</p>
</body>
</html>

Exemple de code pour la vue en anglais (reset-en.blade.php) :

<!DOCTYPE html>
<html>
<head>
    <title>Password Reset</title>
</head>
<body>
    <h1>Password Reset</h1>
    <p>Hello {{ $user->name }},</p>
    <p>You have requested a password reset. To reset your password, click on the following link:</p>
    <p><a href="{{ url('password/reset', $token) }}">Reset my password</a></p>
    <p>Best regards,</p>
    <p>[Your name]</p>
</body>
</html>

1. Pour envoyer le mail en fonction de la langue de l'utilisateur, vous pouvez utiliser la méthode sendResetLinkEmail du contrôleur ResetPasswordController et passer la langue de l'utilisateur en paramètre :

use Illuminate\Support\Facades\Mail;

public function sendResetLinkEmail(Request $request)
{
    $user = User::whereEmail($request->email)->first();
    if ($user) {
        $token = Str::random(60);
        $user->password_reset_token = $token;
        $user->save();
        Mail::send('auth.emails.password.reset-' . $user->language, ['token' => $token, 'user' => $user], function ($message) use ($user) {
            $message->to($user->email)->subject('Réinitialisation de mot de passe');
        });
    }
    return response()->json(['message' => 'Email envoyé avec succès']);
}
